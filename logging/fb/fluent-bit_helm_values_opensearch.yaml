# Override values for the Fluent Bit helm chart
#
# Chart:  https://github.com/fluent/helm-charts/blob/fluent-bit-0.30.4/charts/fluent-bit
# Default values: https://github.com/fluent/helm-charts/blob/fluent-bit-0.30.4/charts/fluent-bit/values.yaml


## NOTE: All image.* and imagePullSecrets keys now derived from environment variables and generated at run-time (do not set here)
###image:
###  repository: foo
###  pullPolicy: foo
###  tag: foo
###imagePullSecrets: foo

podAnnotations: 
  fluentbit.io/parser: fluentbit
podLabels:
  fbout: es
serviceMonitor:
  enabled: false
extraVolumeMounts:
- mountPath: /fluent-bit/etc/viya-parsers.conf
  name: parsers-config
  subPath: viya-parsers.conf
- mountPath: /fluent-bit/etc/viya-tracing.conf
  name: tracing-config
  subPath: viya-tracing.conf
- mountPath: /var/log/v4m-fb-storage
  name: v4m-fb-storage
  readOnly: false
extraVolumes:
###- hostPath:
###    path: /var/log
###    #type: DirectoryOrCreate
###  name: var-log
- hostPath:
    path: /var/log/v4m-fb-storage
    type: DirectoryOrCreate
  name: v4m-fb-storage
- configMap:
    defaultMode: 420
    name: fb-viya-parsers
  name: parsers-config
- configMap:
    defaultMode: 420
    name: fb-viya-tracing
  name: tracing-config
- configMap:
    defaultMode: 0755
    name: fb-dbmigrate-script
  name: dbmigrate-script
fullConfigMap: false
existingConfigMap: fb-fluent-bit-config

env:
   - name: ES_LOGCOLLECTOR_USER
     valueFrom:
       secretKeyRef:
         name: internal-user-logcollector
         key: username
   - name: ES_LOGCOLLECTOR_PASSWD
     valueFrom:
       secretKeyRef:
         name: internal-user-logcollector
         key: password
envFrom:
   - configMapRef:
        name: fb-env-vars


# Be very tolerant
tolerations:
- operator: "Exists"

resources:
#   limits:
#     cpu: 100m
#     memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi

###podSecurityContext:
###  fsGroup: 3301     ###23OCT24

securityContext:
  runAsUser: 3301
  readOnlyRootFilesystem: true
  privileged: false
  capabilities:
    drop: ["all"]
    add: ["CHOWN"]


initContainers:
- name: chowner-v4m-fb-storage
  image: docker.io/library/busybox:latest
  imagePullPolicy: IfNotPresent
  command: ['sh', '-c', "./usr/bin/migrate_fbstate_db.sh"]
  securityContext:
    privileged: true
    readOnlyRootFilesystem: true
    capabilities:
      drop: ["all"]
      add: ["CHOWN"]
    runAsUser: 0
    runAsNonRoot: false
  volumeMounts:
  - name: v4m-fb-storage
    mountPath: /var/log/v4m-fb-storage
  - name: dbmigrate-script
    mountPath: /usr/bin/migrate_fbstate_db.sh
    readOnly: false
    subPath: migrate_fbstate_db.sh
  - mountPath: /var/log
    name: varlog
    readOnly: true

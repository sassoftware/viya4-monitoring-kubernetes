# Autogenerated Ingress Definitions and Storage Class References

Two new *optional* features are now available on an **experimental** basis.  Each
automates the process of defining a common customization which simplifies the 
deployment process.  The first automates the process of defining Kubernetes ingress 
resources which make the various web applications deployed as part of SAS Viya 
Monitoring accessible to users.  The second automates the process of specifying 
the storageClass for the PVC required by some components deployed as part of SAS 
Viya Monitoring.  This automation eliminates the need for users to manually add 
information for these things in the appropriate user-values YAML file within the 
USER_DIR directory used to customize their SAS Viya Monitoring deployment.

It should be noted that this automation only handles a narrow set of options and 
functionality.  Some users may still need to manually define the various user-
values YAML file within the USER_DIR directory to meet their organization’s requirements.
Refer to the [Pre-deployment topic](https://go.documentation.sas.com/doc/en/obsrvcdc/v_003/obsrvdply/p15fe8611w9njkn1fucwbvlz8tyg.htm) within the documentation for details about that process.

This functionality requires an additional utility be available on the host where 
the deployment scripts are run.  A recent version (4.44.3+) of the `yq` utility, specifically 
[the Golang-based version maintained by Mike Farah](https://github.com/mikefarah/yq), must be 
available.  NOTE: while the requirement for this utility is currently only related to 
these experimental features, it is expected to become a standard requirement for the 
entire project within the next one or two releases.

## Autogenerated Ingress Definitions

Administrators use [Kubernetes Ingress resources](https://kubernetes.io/docs/concepts/services-networking/ingress/) 
to make web applications accessible to users.  This project provides sample definitions 
supporting both host-based and path-based Ingress access to all of the web applications 
that can be made available to users.  This includes OpenSearch Dashboards (for reviewing 
collected log messages) and Grafana (for visualization of the metrics and traces collected).
In addition, the samples include examples for making the Prometheus and Alertmanager web 
applications and the OpenSearch API endpoint accessible.  While making this last set of applications 
accessible is not recommended, some organizations may choose to do so.

The new automation leverages these samples by combining them with the appropriate host 
names and other information provided by administrators at deployment time to create 
the corresponding Ingress resources.

It is important to understand the limitations of this automation.
* the generated ingress resources are specific to nginx 
* This automation is “all or nothing”, if you choose to use this functionality ingress 
resources will be defined for all of the web applications even if access to some of 
applications is disabled.
* This automation only supports the specific ingress configuration option included in the 
samples.  If you need additional or a only subset of those included, you will need to 
manually define your ingress resources
* This project uses Helm charts to deploy most of the components deployed.  This also 
impacts the range of options that can be supported.
* Very limited validation of the user provided values is done.  Administrators are 
responsible for ensuring the values they provide are correct.  Incorrect or mismatched 
information may result in the web application being unreachable.

Information on the full set of parameters is provided below.

|Environment Variable|Default Value|Note|
|--|--|--|
|AUTOGENERATE_INGRESS|`false`|When `true` the ingress definitions should be auto-generated|
|BASE_DOMAIN| *none* | **REQUIRED** The host domain used in constructing URLs to web applications on this cluster. `BASE_DOMAIN` is **required** even if providing FQDN for the applications.|
|ROUTING|`host`| `host` or `path` to indicate whether host based or path based ingress should be configured|
|ALERTMANAGER_FQDN|for host-based routing: `$ALERTMANAGER_PATH.$BASE_DOMAIN` <p> for path-based routing: `BASE_DOMAIN`	|Fully Qualified Domain Name to access Alertmanager|
|ALERTMANAGER_INGRESS_ENABLED|`false`|true/false Enable ingress for Alertmanager|
|ALERTMANAGER_PATH|`alertmanager`|host/path segment used to construct FQDN and Paths|
|GRAFANA_FQDN|for host-based routing: `$GRAFANA_PATH.$BASE_DOMAIN` <p> for path-based routing: `BASE_DOMAIN`|Fully Qualified Domain Name to access Grafana|
|GRAFANA_INGRESS_ENABLED|`true`|true/false Enable ingress for Grafana|
|GRAFANA_PATH|`grafana`|host/path segment used to construct FQDN and Paths|
|OPENSEARCH_FQDN| for host-based routing: `$OPENSEARCH_PATH.$BASE_DOMAIN` <p> for path-based routing: `BASE_DOMAIN`|Fully Qualified Domain Name to access OpenSearch|
|OPENSEARCH_INGRESS_ENABLED|`false`|true/false Enable ingress for OpenSearch|
|OPENSEARCH_PATH|`search`|host/path segment used to construct FQDN and Paths|
|OSD_FQDN|for host-based routing: `$OSD_PATH.$BASE_DOMAIN` <p> for path-based routing: `BASE_DOMAIN`|Fully Qualified Domain Name to access OpenSearch Dashboards|
|OSD_INGRESS_ENABLED|`true`|true/false Enable ingress for OpenSearch Dashboards|
|OSD_PATH|dashboards|host/path segment used to construct FQDN and Paths|
|PROMETHEUS_FQDN|for host-based routing: `$PROMETHEUS_PATH.$BASE_DOMAIN` <p> for path-based routing: `BASE_DOMAIN`|Fully Qualified Domain Name to access Prometheus|
|PROMETHEUS_INGRESS_ENABLED| `false`|true/false Enable ingress for Prometheus|
|PROMETHEUS_PATH|`prometheus`|host/path segment used to construct FQDN and Paths|


If a fully qualified domain name is provided for any of the applications , its value will 
override the `BASE_DOMAIN` value.  Conversely, if a fully qualified domain name is not 
provided, it will constructed by combining the `BASE_DOMAIN` and the path for that 
application, for host-based ingress or the BASE_DOMAIN  for path-based ingress.  Default 
paths are provided for each of the applications (as shown above).

As mentioned earlier, this automation is “all or nothing” therefore we recommend you always 
specify a `BASE_DOMAIN` even if you plan on only providing a fully qualified domain name for
OpenSearch Dashboards and/or Grafana.

## Autogenerated Storage Class References

Several components deployed as part of SAS Viya Monitoring require a PVC.  Administrators 
will need to decide on the appropriate [Kubernetes storageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/) to use for these PVC based on the cloud 
provider on which the cluster is located, costs and other factors.  After making these 
decisions, administrators need to provide this information as part of the information passed 
to the appropriate Helm chart prior the deployment process.  This is generally done by 
manually editing the appropriate user-values YAML file in the USER_DIR directory used for 
customizing SAS Viya Monitoring.  The 2nd optional feature, also considered **experimental**
at this time, automates that process and eliminates the need to manually update user-values
YAML files with this information.

**Important limitations/caveats**
* This automation only handles specifying the storageClass for the PVC, it does NOT create any new storageClass resources.
* Any storageClass referenced must exist.  If a storageClass prodded does not exist, the deployment process will fail with an error message.
* You can specify a single storageClass to use for all of the PVC, you can specify a different storageClass for each of the PVC or a combination of those two options.
* This project uses Helm charts to deploy most of the components deployed.  This also 
impacts the range of options that can be supported.
* Very limited validation of the user provided values is done.  Administrators are 
responsible for ensuring the values they provide are correct.  Using an inncorrect storageClass
may result in poor peformance, data loss and/or rendering the component unusable.

The following five components deployed by SAS Viya Monitoring require a PVC.  This automation 
passes the specified storageClass name to Helm during the deployment process.
* OpenSearch
* Alertmanager
* Grafana
* Prometheus 
* Prometheus Pushgateway 

The following table provides details on the environment variables available for configuring this
functionality.

|Environment Variable|Default Value| Description|
|-----|---|--|
|AUTOGENERATE_STORAGECLASS|`false`|When `true` the storageClass assigned to each PVC will be auto-generated|
|STORAGECLASS|*none*|storageClass to be used for PVCs not explictly assigned a storageClass|
|ALERTMANAGER_STORAGECLASS|`$STORAGECLASS`|storageClass for Alertmanager PVC|
|PROMETHEUS_STORAGECLASS|`$STORAGECLASS`|storageClass for Prometheus PVC|
|OPENSEARCH_STORAGECLASS|`$STORAGECLASS`|storageClass for OpenSearch PVC|
|PUSHGATEWAY_STORAGECLASS|`$STORAGECLASS`|storageClass for Prometheus Pushgateway PVC|


# Transitioning from deploying SAS Viya Monitoring using the SAS Viya 4 Deployment (DaC) Project
The [SAS Viya 4 Deployment project] (https://github.com/sassoftware/viya4-deployment) (DaC)
included functionality to deploy SAS Viya Monitoring in conjunction with its primary focus
on deploying SAS Viya 4.  Users who want to transition from using DaC for deploying SAS
Viya Monitoring to using our project's own deployment scripts may find these new autogeneration
capabilities helpful.  

The following table shows DaC configuration variables related to SAS Viya Monitoring with 
information on the environment variables supported by SAS Viya Monitoring and providing similar functionality. In most cases, the DaC processing actually set the values of these environment variables based the DaC configuration variable value.


|DaC Config Var|Environment Variable SAS Viya Monitoring|Notes|
|--|--|--|
|**Ingress object definition**|
||
|`V4M_ROUTING`|`ROUTING`|The type of ingress routing to create.  Note that the environment variable values are slightly different than the values used by the DaC Config Vars (i.e. `host` and `path` vs. `host-based` and `path-based`)|
|`V4M_ALERTMANAGER_FQDN`|`ALERTMANAGER_FQDN`|URL for accessing Alertmanager web app|
|`V4M_ELASTICSEARCH_FQDN`|`OPENSEARCH_FQDN`|URL for accessing OpenSearch API endpoint|
|`V4M_GRAFANA_FQDN`|`GRAFANA_FQDN`|URL for accessing Grafana web app|
|`V4M_KIBANA_FQDN`|`OSD_FQDN`|URL for accessing Alertmanager web app|
|`V4M_PROMETHEUS_FQDN`|`PROMETHEUS_FQDN`|URL for accessing OpenSearch Dashboards web app|    
|`V4M_BASE_DOMAIN`|`BASE_DOMAIN`|The host domain used in constructing URLs to web applications on this cluster.|
||
|**StorageClass specification**|
||
|`V4M_STORAGECLASS`|`STORAGECLASS`|The Kubernetes storageClass to use for PVC.  Note that DaC did NOT support specifying the storageClass for individual PVCs and did not handle the Pushgateway PVC.|
||
|**Password**|
||
|`V4M_GRAFANA_PASSWORD`|`GRAFANA_ADMIN_PASSWORD`|Password for the Grafana admin (superuser) user.|
|`V4M_KIBANA_LOGADM_PASSWORD`|`LOG_LOGADM_PASSWD`|Password for the `logadm` OpenSearch user.|
|`V4M_KIBANA_PASSWORD`|`LOG_ADMIN_PASSWD`|Password for the OpenSearch/OpenSearch Passwords admin (superuser) user.|
|`V4M_KIBANASERVER_PASSWORD`|`ES_KIBANASERVER_PASSWD`|It is *strongly recommended* that you leave this unset and allow the deployment process to  generate a random password|
|`V4M_LOGCOLLECTOR_PASSWORD`|`ES_LOGCOLLECTOR_PASSWD`|It is *strongly recommended* that you leave this unset and allow the deployment process to  generate a random password|
|`V4M_METRICGETTER_PASSWORD`|`ES_METRICGETTER_PASSWD`|It is *strongly recommended* that you leave this unset and allow the deployment process to  generate a random password|
||
|**Miscellaneous**|
|`V4M_NODE_PLACEMENT_ENABLE`|`NODE_PLACEMENT_ENABLE`||
|`V4_CFG_TLS_GENERATOR`|`CERT_GENERATOR`|valid values: "openssl","cert-manager"|
|`V4M_LOGGING_NAMESPACE`|`LOG_NS`|Namespace in which to deploy **log monitoring** components|
|`V4M_MONITORING_NAMESPACE`|`MON_NS`|Namespace in which to deploy **metric monitoring** components|
|`V4M_VERSION`|*none*| Users can use `git checkout` command to select which version of SAS Viya Monitoring to deploy.  In virtually all cases, users should deploy from the `stable` version.|
|`V4M_CUSTOM_CONFIG_USER_DIR`|`USER_DIR`||
